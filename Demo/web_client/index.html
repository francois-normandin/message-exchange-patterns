<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<meta charset="utf-8"/>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<link rel="stylesheet" type="text/css" href="style.css">
		<title>NI Week: Javascript MQTT Client Example</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<script type = "text/javascript" src = "https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>
		<script type = "text/javascript">
		//--------------------------- -------------------------------------------------------------------------------------
		// Script section for managing the client's subscriptions 
		//--------------------------- -------------------------------------------------------------------------------------
		var hostname = "broker.hivemq.com";
		var port = 8000;
		var clientID = ""
		var zone= "None";

		//Get this users IP Address (use this as the client ID) Note: This is using JQuery 
		$.getJSON('https://api.ipify.org?format=jsonp&callback=?', function(data) {
		clientID = (JSON.stringify(data));
		console.log(clientID);
		}); 
 
		// Create a client instance
		client = new Paho.MQTT.Client(hostname, port, clientID);

		// Set callback handlers
		client.onConnectionLost = onConnectionLost;
		client.onMessageArrived = onMessageArrived;

		// Connect the client
		client.connect({onSuccess:onConnect});
		
		// called when the client connects
		function onConnect() {
			// Once a connection has been made, make a subscription and send a message.
			console.log("onConnect");
			//client.subscribe("LabVIEWDemo/traffic-data/zone/A/nb-cars");
			var statusDisplay = document.getElementById("status");
			statusDisplay.innerHTML = "Connected "+hostname; 
			
		}
		// called when the client loses its connection
		function onConnectionLost(responseObject) {
			if (responseObject.errorCode !== 0) {
				console.log("onConnectionLost:"+responseObject.errorMessage);
				var statusDisplay = document.getElementById("status");
				statusDisplay.innerHTML = "Connection Lost"
			}
		}
		// Called when a message arrives
		function onMessageArrived(message) {
			var logMessage = "Message [Topic: " + message.destinationName + ", Payload: "+ message.payloadString+ ", QoS: "+ message.qos+ ", Retained: "+ message.retained+ ", Duplicate: "+ message.duplicate+ "]";
			// Write to console 
			console.log(logMessage);
			// Update message field 
			//document.getElementById("messages").innerHTML += logMessage + "</br>";			
			document.getElementById("messages").innerHTML = logMessage + "</br>" + document.getElementById("messages").innerHTML;
		}
		// Called when the driving stage changes 
		function onVehicleStateChange() {
			//Setup state, log to console
			var state = "Unknown";
			if (document.getElementById("VehicleStatus").checked)state = "Driving";
			else state = "Parked";
			console.log("state: ",state);
			
			//Send message to notify Hub that the state has changed. 
			message = new Paho.MQTT.Message('"'+state.toLowerCase()+'"');
			message.destinationName = "LabVIEWDemo/users/"+clientID+"/state";
			client.send(message); 
		}
		//Called when the zone selection has changed 
		function onVehicleZoneChange(){
			 //Unsubscribe from the previous zone (if any)
			 if (zone != "None"){
				client.unsubscribe("LabVIEWDemo/traffic-data/zone/"+zone+"/nb-cars");
				console.log("unsubscribe: "+zone);
			 }
			 //Get the currently selected zone 
			 zone = document.querySelector('input[name="VehicleZone"]:checked').value;
			
			 //Construct message to notify Hub that we have changed zones 
			 message = new Paho.MQTT.Message('"'+zone+'"');
			 message.destinationName = "LabVIEWDemo/users/"+clientID+"/position";
			 client.send(message); 
			 
			 //Subscribe to the new zone 
			 client.subscribe("LabVIEWDemo/traffic-data/zone/"+zone+"/nb-cars");
			 console.log("subscribe: "+zone);
			 
			 //Update the subscription field 
			 document.getElementById("zonesubscribed").innerHTML = "Subscribed Zone "+zone;
			 
		}
		//--------------------------- -------------------------------------------------------------------------------------
		</script>
	</head>
	<body>
		<h1 id="example_name">MQTT<span style="font-size:25px"> Web Client Example</span><div id="status" style="font-size:14px">Not Connected</div></h1>
		<hr noshade> 
		Vehicle State: 
		<input type="checkbox" id="VehicleStatus" value="0" onclick="onVehicleStateChange();"> Driving<br>
		Vehicle Zone: 
		<input type="radio" id = "VehicleZone" name="VehicleZone" value="A" onclick="onVehicleZoneChange();"> Zone A 
		<input type="radio" id = "VehicleZone" name="VehicleZone" value="B" onclick="onVehicleZoneChange();"> Zone B 
		<input type="radio" id = "VehicleZone" name="VehicleZone" value="C" onclick="onVehicleZoneChange();"> Zone C 
		<hr noshade>
		<br><div id="zonesubscribed" style="font-size:24px">Subscribed None</div><p id="messages"></p>
	</body>
</html>
